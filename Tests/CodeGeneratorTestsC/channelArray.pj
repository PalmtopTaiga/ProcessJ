import std.io;

proc void f(chan<int>.read chan1, chan<int>.write chan2, int id){
  int x = 0;

  while(true){
    if(id % 2 == 0){
      x = chan1.read();
      chan2.write(x + id);
    }
    else{
      chan2.write(id + x);
      x = chan1.read();
    }
    println("Proc[" + id + "] had value: " + x);
  }

  return;
}

proc void main(){
  int SIZE = 1000000 * 4;
  chan<int>[] array;
  array = new chan<int>[SIZE];

  par for(int i = 0; i < SIZE - 1; i++){
    int writeIndex = i + 1 % SIZE;
    f(array[i].read, array[writeIndex].write, i);
  }

  return;
}
